<head>
    <link rel='stylesheet' href='/stylesheets/users.css' />
</head>

<div id="all">
<div class="userbox">
    <div class="profile">
        <img src="{{user.picture}}" class="profile-pic">
        <div class="profile-contents">
            <div class="profile-name">{{user.firstName}} {{user.lastName}}</div>
            <div>@{{user.username}}</div>
            <div>{{user.bio}}</div>
        </div>
    </div>
</br>
    <form>
      <div class="form-group">
        <label>Find a friend</label>
        <!-- <input id="recipient" name="recipient" class="form-control" placeholder="Pick a friend..."> -->
        <div class="bs-docs-example no-code">
          <select class="friendpicker" data-live-search="true">
            {{#each friends}}
            <option>@{{this.username}}</option>
            {{/each}}
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Send a happy message!</label>
        <textarea id="msgContent" name="content" class="form-control" placeholder="Send them a message to make them smile :)"></textarea>
      </div>
      <div class="form-group">
          <input id="checkBox" type="checkbox"> &nbsp;
         <label>Reveal your Identity?</label>
      </div>
      <div class="user-buttons">
          <form class="form-group">
            <button id="newMessage" type="submit" class="btn">Send a message</button>
          </form>
          <form class="form-group" method="get" action="/contacts/new">
            <button type="submit" class="btn">Find a new friend</button>
          </form>
      </div>
    </form>

</div>

<div class="messagebox">
    <div class="toggle">
      <button id="receiveBtn" type="submit" class="toggle-received">Received</button>
      <button id="sendBtn" type="submit" class="toggle-sent">Sent</button>
    </div>


  <div class="receivedBlock">
    {{#each received}}
      <div id="thread" for="{{this._id}}">
          <div id="message">
              <div class="message-row">
                  <div class="message-row-row">
                      <div>
                          <img id="message-pic" src="./assets/profile.png">
                      </div>
                      <div class="first-contents">
                          <div class="first-message">{{firstMessage.content}}</div>
                          {{#if anonymousSender}}
                            <div class="first-from">Sent by {{participant1.firstName}} {{participant1.lastName}}</div>
                          {{else}}
                            <div class="first-from">Sent anonymously at {{firstMessage.createdAt}}.</div>
                          {{/if}}
                      </div>
                  </div>
                  <img class="thread-pic" src="./assets/comment.png">
              </div>
              {{#each this.replies}}
                <div class="reply">
                    <img id="reply-pic" src="./assets/profile.png">
                    <p>{{this.content}}</p>
                </div>
              {{/each}}
              <div class="reply-input">
                <textarea id="replyContent" name="content" class="form-control" placeholder="Keep the conversation going :)"></textarea>
                <button id="newReply" type="submit" class="btn">Reply</button>
              </div>
          </div>
      </div>
    {{/each}}
  </div>

  <div class="sentBlock">
    {{#each sent}}
      <div id="thread" for="{{this._id}}">
          <div id="message">
              <div class="message-row">
                  <div class="message-row-row">
                      <div>
                          <img id="message-pic" src="./assets/profile.png">
                      </div>
                      <div class="first-contents">
                          <div class="first-message">{{firstMessage.content}}</div>
                          {{#if anonymousSender}}
                            <div class="first-from">Sent by {{participant1.firstName}} {{participant1.lastName}}</div>
                          {{else}}
                            <div class="first-from">Sent anonymously at {{firstMessage.createdAt}}.</div>
                          {{/if}}
                      </div>
                  </div>
                  <img class="thread-pic" src="./assets/comment.png">
              </div>
              {{#each this.replies}}
                <div class="reply">
                    <img id="reply-pic" src="./assets/profile.png">
                    <p>{{this.content}}</p>
                </div>
              {{/each}}
              <div class="reply-input">
                <textarea id="replyContent" name="content" class="form-control" placeholder="Keep the conversation going :)"></textarea>
                <button id="newReply" type="submit" class="btn">Reply</button>
              </div>
          </div>
      </div>
    {{/each}}
  </div>

  </br>
</div>



</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>

<script>
  var socket = io('localhost:3000');

  // Receive emits from routes.js when new message is posted
  socket.on('newMessage', function(thread) {
    // add message to message thread body
    console.log("Thread in : " + thread.firstMessage)
    console.log("This is it: " + thread.firstMessage.content)
    // $('#messages').append(message.content)
  })
  socket.on('negativeMessage', function() {

  })
  socket.on('dirtyMessage', function() {

  })

  // Receive emits from routes.js when new REPLY is posted
  socket.on('newReply', function(thread) {
    // add message to message thread body
    console.log("Replied with " + thread.firstMessage)
  })
  socket.on('negativeReply', function() {

  })
  socket.on('dirtyReply', function() {

  })

  $(document).ready(function() {
    $('.receivedBlock').show();
    $('.sentBlock').hide();

    // When New Message button is pushed
    $('#newMessage').click(function(event) {
      event.preventDefault();
      var bodyMsg = $('#msgContent').val();
      // to is username of recipient

      var recipient = $(".friendpicker option:selected").text().slice(1);


      var anon = $('#anon').is(":checked");
      $('#msgContent').val('')
      $('#recipient').val('')
      $('#anon').val('')
      socket.emit('newMessage', {
        user: "{{user._id}}",
        content: bodyMsg,
        receiver: recipient,
        anon: anon
      })
    })

    // When Reply button is pushed; See Leo's spec for more information
    $('#newReply').click(function() {
      event.preventDefault();
      var bodyMsg = $('#replyContent').val();
      $('#replyContent').val('')
      var threadid = $(this).parent().parent().parent().attr('for')
      console.log(threadid)
      socket.emit('newReply', {
        user: "{{user._id}}",
        threadid: threadid,
        content: bodyMsg
      })
    })

    $('#receiveBtn').click(function() {
      $('.receivedBlock').show();
      $('.sentBlock').hide();
    })

    $('#sendBtn').click(function() {
      $('.receivedBlock').hide();
      $('.sentBlock').show();
    })

  })



</script>
